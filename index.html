<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>今日の献立どうする？ AIらくちんレシピ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* カスタムスタイル */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: #ffeef2; /* ポップな背景色 */
        }
        .container {
            max-width: 800px;
        }
        .card {
            box-shadow: 0 8px 15px -3px rgba(255, 105, 180, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* 影をピンクに */
        }
        .loading-spinner {
            border-top-color: #f3f3f3;
            border-left-color: #f3f3f3;
            border-right-color: #ff69b4; /* ピンク */
            border-bottom-color: #ff69b4; /* ピンク */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* モード切り替えボタンのデザイン */
        .mode-button {
            transition: all 0.2s;
            cursor: pointer;
            border-radius: 9999px; /* pill shape */
            padding: 0.5rem 1.25rem;
            font-weight: 600;
            background-color: #ffffff;
            color: #ff69b4; /* Pink */
            border: 2px solid #ffb6c1; /* Light Pink border */
            white-space: nowrap; /* ボタンのテキストが折り返さないように */
        }
        .mode-button.active {
            background-color: #ff69b4; /* Pink */
            color: white;
            border-color: #ff69b4;
            box-shadow: 0 4px 6px rgba(255, 105, 180, 0.4);
        }

        /* 詳細レシピモーダルのスタイル */
        .modal-content {
            max-height: 80vh; /* モーダルの高さを制限 */
            overflow-y: auto; /* スクロール可能に */
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div id="app" class="container mx-auto">
        <!-- ヘッダーエリア -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-pink-600 mb-2">今日の献立どうする？</h1>
            <h2 class="text-3xl font-extrabold text-gray-800 mb-2">AIらくちんレシピ</h2>
            <!-- 句点を削除し、食材のガイダンスを修正 -->
            <p class="text-gray-500">食材とモードを選ぶだけで、献立を即座に提案します ✨</p>
        </header>

        <!-- 免責事項モーダル -->
        <div id="disclaimerBox" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-50 overflow-y-auto">
            <div class="bg-white p-6 rounded-xl shadow-2xl modal-lg w-full my-8">
                <h3 class="text-2xl font-bold text-primary mb-4 border-b pb-2">免責事項</h3>
                <div class="text-gray-700 text-sm space-y-4 max-h-96 overflow-y-auto pr-2">
                    <p class="font-semibold">【本サービスのご利用にあたっての重要事項】</p>
                    <p>
                        本サービス「今日の献立どうする？ AIらくちんレシピ」が提案する献立、レシピ、調理のヒントは、大規模言語モデル（AI）によって生成されたものです。以下の点にご注意いただき、ご利用者様ご自身の責任と判断においてご活用ください。
                    </p>
                    <ul class="list-disc list-inside space-y-2 pl-4">
                        <li>**安全性と衛生管理:** 提案されたレシピを実行する際は、食材の鮮度、調理器具の衛生状態、調理時間、加熱温度などを必ずご自身の責任で確認し、食中毒や怪我のないよう細心の注意を払ってください。</li>
                        <li>**アレルギー対応:** アレルギー除去モードを使用した場合でも、AIの提案が完璧である保証はありません。アレルゲンを含む可能性のある調味料や隠し味、加工食品の使用の有無について、**必ずご自身の目と責任で成分表示を確認してください。** 本サービスは、アレルギーによる健康被害に関して一切の責任を負いません。</li>
                        <li>**栄養と健康:** 提案される献立は一般的な情報に基づいていますが、特定の疾患を持つ方や厳密な栄養管理が必要な方は、必ず専門医や管理栄養士にご相談ください。本サービスは医療行為や栄養指導の代替ではありません。</li>
                        <li>**情報の正確性:** AIが提供する情報には、稀に誤りや不正確な情報が含まれる可能性があります。調理手順や分量については、常識の範囲内で調整をお願いいたします。</li>
                        <li>**利用上の損害:** 本サービスを利用したこと、または利用できなかったことによって生じた一切の損害（直接的、間接的を問わず）について、当方は責任を負いません。</li>
                    </ul>
                    <p class="mt-4 text-xs text-gray-500">
                        本サービスをご利用いただいた時点で、上記の免責事項に同意いただいたものと見なします。
                    </p>
                </div>
                <button onclick="hideMessageBox('disclaimerBox')" class="mt-6 w-full bg-primary text-white font-semibold py-3 rounded-xl hover:bg-red-600 transition">同意して閉じる</button>
            </div>
        </div>

        <!-- メイン入力フォーム -->
        <div class="card bg-white p-6 md:p-8 rounded-2xl mb-8">
            
            <!-- 食材入力 -->
            <div class="mb-4">
                <!-- 絵文字を追加 -->
                <label for="ingredients" class="block text-lg font-medium text-gray-700 mb-2">使いたい食材を入力してください (例: 鶏むね肉, 玉ねぎ, 豆腐) 🥕</label>
                <input type="text" id="ingredients" placeholder="使いたい食材を入力..."
                       class="w-full p-3 border border-pink-300 rounded-xl focus:ring-pink-500 focus:border-pink-500" required>
            </div>

            <!-- モード選択 (ラベルを削除) -->
            <div class="mb-6">
                <div id="mode-selector" class="flex flex-wrap gap-3">
                    <!-- ボタンから「モード」を削除し、「アレルギー除去」に変更 -->
                    <button type="button" class="mode-button active" data-mode="normal">通常</button>
                    <button type="button" class="mode-button" data-mode="health">ヘルシー</button>
                    <button type="button" class="mode-button" data-mode="allergy" id="allergy-mode-button">アレルギー除去</button>
                </div>
                <input type="hidden" id="current-mode" value="normal">
            </div>

            <!-- アレルギー入力 (アレルギーモード選択時に表示) -->
            <div id="allergy-input-group" class="mb-4 hidden">
                <!-- 「除去すべきアレルゲン」を「除去する食材」に変更 -->
                <label for="allergens" class="block text-sm font-medium text-red-700 mb-2">除去する食材を入力してください (例: 卵, 乳製品, 小麦)</label>
                <input type="text" id="allergens" placeholder="除去したい食材を入力..."
                       class="w-full p-3 border border-red-300 rounded-xl focus:ring-red-500 focus:border-red-500">
            </div>

            <!-- 提案ボタン -->
            <button id="generate-button"
                    class="w-full bg-pink-600 text-white font-semibold py-3 rounded-xl hover:bg-pink-700 transition duration-150 shadow-lg flex items-center justify-center disabled:opacity-50"
                    onclick="generateMenu()">
                <!-- ボタンのテキストを「今日の献立をお願い！」に変更 -->
                <span id="button-text">今日の献立をお願い！</span>
                <div id="loading-spinner" class="loading-spinner w-5 h-5 border-4 rounded-full ml-2 hidden"></div>
            </button>

            <!-- エラーメッセージ表示エリア -->
            <div id="error-message" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden"></div>
        </div>

        <!-- 献立結果表示エリア -->
        <div id="results-area" class="space-y-6">
            <!-- AI生成結果がここに動的に挿入されます -->
        </div>

        <!-- メッセージボックス (汎用アラート) -->
        <div id="message-box" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-lg shadow-2xl w-80">
                <p id="message-text" class="text-gray-700 mb-4 text-center"></p>
                <button onclick="closeMessageBox()" class="w-full bg-pink-600 text-white py-2 rounded-lg hover:bg-pink-700 transition duration-150">OK</button>
            </div>
        </div>

        <!-- 詳細レシピモーダル -->
        <div id="recipe-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden p-4">
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl w-full max-w-xl modal-content">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h3 class="text-2xl font-bold text-gray-800" id="modal-dish-name"></h3>
                    <button onclick="closeRecipeModal()" class="text-gray-500 hover:text-gray-700 text-2xl font-light">
                        &times;
                    </button>
                </div>
                
                <!-- 詳細レシピのロード中/表示エリア -->
                <div id="modal-loading-spinner" class="text-center py-8 hidden">
                    <div class="loading-spinner w-8 h-8 border-4 mx-auto rounded-full mb-2"></div>
                    <p class="text-pink-600 font-medium">詳細レシピを生成中...</p>
                </div>

                <div id="modal-content-area">
                    <!-- 詳細レシピがここに挿入されます -->
                </div>

            </div>
        </div>
    </div>

    <script>
        // グローバル変数としてingredientsとmodeを保持
        let currentIngredients = '';
        let currentMode = 'normal';

        document.addEventListener('DOMContentLoaded', () => {
            const modeSelector = document.getElementById('mode-selector');
            const modeButtons = modeSelector.querySelectorAll('.mode-button');
            const currentModeInput = document.getElementById('current-mode');
            const allergyInputGroup = document.getElementById('allergy-input-group');
            
            // モードボタンの切り替えロジック
            modeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    modeButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    const mode = button.getAttribute('data-mode');
                    currentModeInput.value = mode;
                    currentMode = mode; // グローバル変数も更新

                    // アレルギー入力の表示/非表示
                    if (mode === 'allergy') {
                        allergyInputGroup.classList.remove('hidden');
                    } else {
                        allergyInputGroup.classList.add('hidden');
                        document.getElementById('allergens').value = ''; // アレルゲン入力をクリア
                    }
                });
            });
        });

        // メッセージボックス制御 (汎用アラート)
        function showMessageBox(message) {
            document.getElementById('message-text').textContent = message;
            document.getElementById('message-box').classList.remove('hidden');
        }

        function closeMessageBox() {
            document.getElementById('message-box').classList.add('hidden');
        }
        
        // 詳細レシピモーダル制御
        function openRecipeModal() {
            document.getElementById('recipe-modal').classList.remove('hidden');
        }

        function closeRecipeModal() {
            document.getElementById('recipe-modal').classList.add('hidden');
            document.getElementById('modal-content-area').innerHTML = ''; // コンテンツをクリア
        }

        /**
         * 献立生成のメイン処理
         */
        async function generateMenu() {
            const ingredients = document.getElementById('ingredients').value.trim();
            const mode = document.getElementById('current-mode').value;
            const allergens = document.getElementById('allergens').value.trim();
            const errorMessageDiv = document.getElementById('error-message');
            const generateButton = document.getElementById('generate-button');
            const buttonText = document.getElementById('button-text');
            const spinner = document.getElementById('loading-spinner');
            const resultsArea = document.getElementById('results-area');

            errorMessageDiv.classList.add('hidden');
            
            if (!ingredients) {
                showMessageBox("使いたい食材が入力されていません。");
                return;
            }

            // グローバル変数を更新
            currentIngredients = ingredients;
            currentMode = mode;

            // UIをローディング状態に
            generateButton.disabled = true;
            buttonText.textContent = 'AIが献立を考案中...';
            spinner.classList.remove('hidden');
            resultsArea.innerHTML = ''; // 結果エリアをクリア

            try {
                // Vercelのサーバーレス関数エンドポイント
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ ingredients, mode, allergens }),
                });

                if (!response.ok) {
                    const errorJson = await response.json();
                    let message = errorJson.message || `献立生成エラー: ステータス: ${response.status}`;
                    throw new Error(message);
                }

                const data = await response.json();
                // 献立データと、入力されたingredients, modeを渡す
                renderResults(data.menuData, ingredients, mode);

            } catch (error) {
                console.error("Fetch Error:", error);
                errorMessageDiv.textContent = `エラーが発生しました: ${error.message}`;
                errorMessageDiv.classList.remove('hidden');
            } finally {
                // UIを通常状態に戻す
                generateButton.disabled = false;
                // 修正後のテキストに戻す
                buttonText.textContent = '今日の献立をお願い！';
                spinner.classList.add('hidden');
            }
        }

        /**
         * 献立結果をレンダリングする (詳細ボタン付き)
         * @param {Array<Object>} menuData - AIから返された献立データ
         */
        function renderResults(menuData) {
            const resultsArea = document.getElementById('results-area');
            resultsArea.innerHTML = ''; // 結果エリアをクリア

            // 献立レベルの表示順を定義
            const order = {
                '究極のズボラ飯 (5分以内)': 1, 
                '手軽・時短献立': 2,
                'ちょっとひと手間献立': 3
            };

            // 取得したデータを定義した順序でソート
            const sortedData = menuData.sort((a, b) => {
                return order[a.level] - order[b.level];
            });

            sortedData.forEach(menu => {
                let cardClass = '';
                let levelName = menu.level;
                let levelIcon = '';
                let levelColor = '';

                // レベルに応じてデザインと名称を決定
                if (levelName === '究極のズボラ飯 (5分以内)') {
                    cardClass = 'bg-yellow-50 border-yellow-300';
                    levelIcon = '😴'; // ズボラ
                    levelColor = 'bg-yellow-500';
                } else if (levelName === '手軽・時短献立') { // 修正
                    cardClass = 'bg-green-50 border-green-300';
                    levelIcon = '⏱️'; // 時短
                    levelColor = 'bg-green-500';
                } else if (levelName === 'ちょっとひと手間献立献立') {
                    cardClass = 'bg-pink-50 border-pink-300';
                    levelIcon = '👑'; // ひと手間
                    levelColor = 'bg-pink-500';
                } else {
                    cardClass = 'bg-gray-50 border-gray-300';
                    levelIcon = '🍳';
                    levelColor = 'bg-gray-500';
                }

                const cardHtml = `
                    <div class="card ${cardClass} border-2 p-6 rounded-2xl transition duration-300 hover:shadow-xl">
                        <h3 class="text-xl md:text-2xl font-bold text-gray-800 mb-2 flex items-center">
                            <span class="p-1 rounded-full text-white ${levelColor} mr-3">
                                ${levelIcon}
                            </span>
                            ${levelName}
                        </h3>
                        
                        <h4 class="text-lg font-semibold text-gray-700 mb-2">${menu.dishName}</h4>
                        <p class="text-gray-600 mb-4">${menu.description}</p>
                        
                        <div class="p-4 bg-white rounded-xl border border-dashed border-pink-200 mb-4">
                            <h5 class="text-md font-bold text-gray-700 mb-2 flex items-center text-pink-600">
                                <span class="mr-2">💡</span>調理のポイント
                            </h5>
                            <div class="text-sm text-gray-600 recipe-summary-content">
                                ${formatSummary(menu.recipeSummary)}
                            </div>
                        </div>
                    </div>
                `;
                resultsArea.insertAdjacentHTML('beforeend', cardHtml);
            });
        }

        /**
         * 詳細レシピをサーバーレス関数から取得し、モーダルに表示する
         * @param {string} dishName - 詳細を取得したい献立名
         */
        async function fetchDetailRecipe(dishName) {
            const modalName = document.getElementById('modal-dish-name');
            const modalContent = document.getElementById('modal-content-area');
            const modalSpinner = document.getElementById('modal-loading-spinner');
            const errorMessageDiv = document.getElementById('error-message');

            // モーダルを表示し、献立名を設定
            modalName.textContent = dishName;
            modalContent.innerHTML = '';
            openRecipeModal();
            
            // UIをローディング状態に
            modalSpinner.classList.remove('hidden');
            errorMessageDiv.classList.add('hidden');
            
            try {
                // 新しく作成したサーバーレス関数 /api/detail を呼び出す
                // サーバーレス関数がない場合のエラーを解消するため、api/detail.js を作成します
                const response = await fetch('/api/detail', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        dishName: dishName,
                        ingredients: currentIngredients, // 最初の入力食材を渡す
                        mode: currentMode // 選択中のモードを渡す
                    }),
                });

                if (!response.ok) {
                    // JSONエラーではなく、サーバーからのエラーレスポンスを正しく処理する
                    let errorText;
                    try {
                        // 応答がJSON形式であれば解析
                        const errorJson = await response.json();
                        errorText = errorJson.message || `ステータス: ${response.status}`;
                    } catch {
                        // 応答がJSON形式でなければテキストとして取得
                        errorText = await response.text();
                    }
                    throw new Error(errorText);
                }

                const data = await response.json();
                renderDetailRecipe(data.detailRecipe);

            } catch (error) {
                console.error("Detail Recipe Fetch Error:", error);
                closeRecipeModal();
                showMessageBox(`詳細レシピの取得中にエラーが発生しました: ${error.message}`);
            } finally {
                // UIを通常状態に戻す
                modalSpinner.classList.add('hidden');
            }
        }
        
        /**
         * 栄養分析のダミー処理（未実装）
         */
        function fetchNutritionAnalysis(dishName) {
            showMessageBox(`「${dishName}」の栄養分析機能を実行しようとしましたが、現在この機能はまだ開発中です！😋`);
        }

        /**
         * 詳細レシピデータをモーダルにレンダリングする
         * @param {Object} recipeData - 詳細レシピデータ
         */
        function renderDetailRecipe(recipeData) {
            const modalContent = document.getElementById('modal-content-area');
            
            const ingredientsHtml = `
                <div class="mb-6">
                    <h4 class="text-xl font-bold text-pink-600 mb-3 border-b-2 border-pink-200 pb-1">材料 (${recipeData.yield})</h4>
                    <p class="text-sm text-gray-500 mb-2">調理時間: ${recipeData.totalTime}</p>
                    <ul class="list-disc pl-5 space-y-2 text-gray-700">
                        ${recipeData.ingredientsList.map(item => `<li>${item}</li>`).join('')}
                    </ul>
                </div>
            `;

            const instructionsHtml = `
                <div class="mb-4">
                    <h4 class="text-xl font-bold text-pink-600 mb-3 border-b-2 border-pink-200 pb-1">作り方</h4>
                    <ol class="list-decimal pl-5 space-y-3 text-gray-700">
                        ${recipeData.instructions.map(item => `<li>${item}</li>`).join('')}
                    </ol>
                </div>
            `;

            modalContent.innerHTML = ingredientsHtml + instructionsHtml;
        }


        /**
         * AIが返した箇条書きを番号付きリストに変換する
         */
        function formatSummary(summaryHtml) {
            // AIが <ul><li>タグを使用する前提で、それを <ol><li>に変換
            if (summaryHtml.includes('<ul>')) {
                // <ul> を <ul class="list-none space-y-2"> に置換
                summaryHtml = summaryHtml.replace(/<ul\s*[^>]*>/gi, '<ul class="list-none space-y-2">');
                // </ul> を </ul> に置換（番号はAI側で付与される前提）
                summaryHtml = summaryHtml.replace(/<\/ul\s*[^>]*>/gi, '</ul>');
            }
            return summaryHtml;
        }

    </script>
</body>
</html>
