<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»Šæ—¥ã®çŒ®ç«‹ã©ã†ã™ã‚‹ï¼Ÿ AIã‚‰ãã¡ã‚“ãƒ¬ã‚·ãƒ”</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: #ffeef2; /* ãƒãƒƒãƒ—ãªèƒŒæ™¯è‰² */
        }
        .container {
            max-width: 800px;
        }
        .card {
            box-shadow: 0 8px 15px -3px rgba(255, 105, 180, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* å½±ã‚’ãƒ”ãƒ³ã‚¯ã« */
        }
        .loading-spinner {
            border-top-color: #f3f3f3;
            border-left-color: #f3f3f3;
            border-right-color: #ff69b4; /* ãƒ”ãƒ³ã‚¯ */
            border-bottom-color: #ff69b4; /* ãƒ”ãƒ³ã‚¯ */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .mode-button {
            transition: all 0.2s;
            cursor: pointer;
            border-radius: 9999px; /* pill shape */
            padding: 0.5rem 1.25rem;
            font-weight: 600;
            background-color: #ffffff;
            color: #ff69b4; /* Pink */
            border: 2px solid #ffb6c1; /* Light Pink border */
            white-space: nowrap; /* ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆãŒæŠ˜ã‚Šè¿”ã•ãªã„ã‚ˆã†ã« */
        }
        .mode-button.active {
            background-color: #ff69b4; /* Pink */
            color: white;
            border-color: #ff69b4;
            box-shadow: 0 4px 6px rgba(255, 105, 180, 0.4);
        }

        /* è©³ç´°ãƒ¬ã‚·ãƒ”ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .modal-content {
            max-height: 80vh; /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®é«˜ã•ã‚’åˆ¶é™ */
            overflow-y: auto; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã« */
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div id="app" class="container mx-auto">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¨ãƒªã‚¢ -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-pink-600 mb-2">ä»Šæ—¥ã®çŒ®ç«‹ã©ã†ã™ã‚‹ï¼Ÿ</h1>
            <h2 class="text-3xl font-extrabold text-gray-800 mb-2">AIã‚‰ãã¡ã‚“ãƒ¬ã‚·ãƒ”</h2>
            <!-- å¥ç‚¹ã‚’å‰Šé™¤ã—ã€é£Ÿæã®ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ã‚’ä¿®æ­£ -->
            <p class="text-gray-500">é£Ÿæã¨ãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã¶ã ã‘ã§ã€çŒ®ç«‹ã‚’å³åº§ã«ææ¡ˆã—ã¾ã™ âœ¨</p>
        </header>

        <!-- å…è²¬äº‹é …ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="disclaimerBox" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-50 overflow-y-auto">
            <div class="bg-white p-6 rounded-xl shadow-2xl modal-lg w-full my-8">
                <h3 class="text-2xl font-bold text-primary mb-4 border-b pb-2">å…è²¬äº‹é …</h3>
                <div class="text-gray-700 text-sm space-y-4 max-h-96 overflow-y-auto pr-2">
                    <p class="font-semibold">ã€æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã®ã”åˆ©ç”¨ã«ã‚ãŸã£ã¦ã®é‡è¦äº‹é …ã€‘</p>
                    <p>
                        æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã€Œä»Šæ—¥ã®çŒ®ç«‹ã©ã†ã™ã‚‹ï¼Ÿ AIã‚‰ãã¡ã‚“ãƒ¬ã‚·ãƒ”ã€ãŒææ¡ˆã™ã‚‹çŒ®ç«‹ã€ãƒ¬ã‚·ãƒ”ã€èª¿ç†ã®ãƒ’ãƒ³ãƒˆã¯ã€å¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ï¼ˆAIï¼‰ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚ŒãŸã‚‚ã®ã§ã™ã€‚ä»¥ä¸‹ã®ç‚¹ã«ã”æ³¨æ„ã„ãŸã ãã€ã”åˆ©ç”¨è€…æ§˜ã”è‡ªèº«ã®è²¬ä»»ã¨åˆ¤æ–­ã«ãŠã„ã¦ã”æ´»ç”¨ãã ã•ã„ã€‚
                    </p>
                    <ul class="list-disc list-inside space-y-2 pl-4">
                        <li>**å®‰å…¨æ€§ã¨è¡›ç”Ÿç®¡ç†:** ææ¡ˆã•ã‚ŒãŸãƒ¬ã‚·ãƒ”ã‚’å®Ÿè¡Œã™ã‚‹éš›ã¯ã€é£Ÿæã®é®®åº¦ã€èª¿ç†å™¨å…·ã®è¡›ç”ŸçŠ¶æ…‹ã€èª¿ç†æ™‚é–“ã€åŠ ç†±æ¸©åº¦ãªã©ã‚’å¿…ãšã”è‡ªèº«ã®è²¬ä»»ã§ç¢ºèªã—ã€é£Ÿä¸­æ¯’ã‚„æ€ªæˆ‘ã®ãªã„ã‚ˆã†ç´°å¿ƒã®æ³¨æ„ã‚’æ‰•ã£ã¦ãã ã•ã„ã€‚</li>
                        <li>**ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼å¯¾å¿œ:** ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼é™¤å»ãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ãŸå ´åˆã§ã‚‚ã€AIã®ææ¡ˆãŒå®Œç’§ã§ã‚ã‚‹ä¿è¨¼ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¢ãƒ¬ãƒ«ã‚²ãƒ³ã‚’å«ã‚€å¯èƒ½æ€§ã®ã‚ã‚‹èª¿å‘³æ–™ã‚„éš ã—å‘³ã€åŠ å·¥é£Ÿå“ã®ä½¿ç”¨ã®æœ‰ç„¡ã«ã¤ã„ã¦ã€**å¿…ãšã”è‡ªèº«ã®ç›®ã¨è²¬ä»»ã§æˆåˆ†è¡¨ç¤ºã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚** æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã«ã‚ˆã‚‹å¥åº·è¢«å®³ã«é–¢ã—ã¦ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚</li>
                        <li>**æ „é¤Šã¨å¥åº·:** ææ¡ˆã•ã‚Œã‚‹çŒ®ç«‹ã¯ä¸€èˆ¬çš„ãªæƒ…å ±ã«åŸºã¥ã„ã¦ã„ã¾ã™ãŒã€ç‰¹å®šã®ç–¾æ‚£ã‚’æŒã¤æ–¹ã‚„å³å¯†ãªæ „é¤Šç®¡ç†ãŒå¿…è¦ãªæ–¹ã¯ã€å¿…ãšå°‚é–€åŒ»ã‚„ç®¡ç†æ „é¤Šå£«ã«ã”ç›¸è«‡ãã ã•ã„ã€‚æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã¯åŒ»ç™‚è¡Œç‚ºã‚„æ „é¤ŠæŒ‡å°ã®ä»£æ›¿ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>
                        <li>**æƒ…å ±ã®æ­£ç¢ºæ€§:** AIãŒæä¾›ã™ã‚‹æƒ…å ±ã«ã¯ã€ç¨€ã«èª¤ã‚Šã‚„ä¸æ­£ç¢ºãªæƒ…å ±ãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚èª¿ç†æ‰‹é †ã‚„åˆ†é‡ã«ã¤ã„ã¦ã¯ã€å¸¸è­˜ã®ç¯„å›²å†…ã§èª¿æ•´ã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚</li>
                        <li>**åˆ©ç”¨ä¸Šã®æå®³:** æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã—ãŸã“ã¨ã€ã¾ãŸã¯åˆ©ç”¨ã§ããªã‹ã£ãŸã“ã¨ã«ã‚ˆã£ã¦ç”Ÿã˜ãŸä¸€åˆ‡ã®æå®³ï¼ˆç›´æ¥çš„ã€é–“æ¥çš„ã‚’å•ã‚ãšï¼‰ã«ã¤ã„ã¦ã€å½“æ–¹ã¯è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚</li>
                    </ul>
                    <p class="mt-4 text-xs text-gray-500">
                        æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã”åˆ©ç”¨ã„ãŸã ã„ãŸæ™‚ç‚¹ã§ã€ä¸Šè¨˜ã®å…è²¬äº‹é …ã«åŒæ„ã„ãŸã ã„ãŸã‚‚ã®ã¨è¦‹ãªã—ã¾ã™ã€‚
                    </p>
                </div>
                <button onclick="hideMessageBox('disclaimerBox')" class="mt-6 w-full bg-primary text-white font-semibold py-3 rounded-xl hover:bg-red-600 transition">åŒæ„ã—ã¦é–‰ã˜ã‚‹</button>
            </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div class="card bg-white p-6 md:p-8 rounded-2xl mb-8">
            
            <!-- é£Ÿæå…¥åŠ› -->
            <div class="mb-4">
                <!-- çµµæ–‡å­—ã‚’è¿½åŠ  -->
                <label for="ingredients" class="block text-lg font-medium text-gray-700 mb-2">ä½¿ã„ãŸã„é£Ÿæã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (ä¾‹: é¶ã‚€ã­è‚‰, ç‰ã­ã, è±†è…) ğŸ¥•</label>
                <input type="text" id="ingredients" placeholder="ä½¿ã„ãŸã„é£Ÿæã‚’å…¥åŠ›..."
                       class="w-full p-3 border border-pink-300 rounded-xl focus:ring-pink-500 focus:border-pink-500" required>
            </div>

            <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠ (ãƒ©ãƒ™ãƒ«ã‚’å‰Šé™¤) -->
            <div class="mb-6">
                <div id="mode-selector" class="flex flex-wrap gap-3">
                    <!-- ãƒœã‚¿ãƒ³ã‹ã‚‰ã€Œãƒ¢ãƒ¼ãƒ‰ã€ã‚’å‰Šé™¤ã—ã€ã€Œã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼é™¤å»ã€ã«å¤‰æ›´ -->
                    <button type="button" class="mode-button active" data-mode="normal">é€šå¸¸</button>
                    <button type="button" class="mode-button" data-mode="health">ãƒ˜ãƒ«ã‚·ãƒ¼</button>
                    <button type="button" class="mode-button" data-mode="allergy" id="allergy-mode-button">ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼é™¤å»</button>
                </div>
                <input type="hidden" id="current-mode" value="normal">
            </div>

            <!-- ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼å…¥åŠ› (ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãƒ¢ãƒ¼ãƒ‰é¸æŠæ™‚ã«è¡¨ç¤º) -->
            <div id="allergy-input-group" class="mb-4 hidden">
                <!-- ã€Œé™¤å»ã™ã¹ãã‚¢ãƒ¬ãƒ«ã‚²ãƒ³ã€ã‚’ã€Œé™¤å»ã™ã‚‹é£Ÿæã€ã«å¤‰æ›´ -->
                <label for="allergens" class="block text-sm font-medium text-red-700 mb-2">é™¤å»ã™ã‚‹é£Ÿæã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (ä¾‹: åµ, ä¹³è£½å“, å°éº¦)</label>
                <input type="text" id="allergens" placeholder="é™¤å»ã—ãŸã„é£Ÿæã‚’å…¥åŠ›..."
                       class="w-full p-3 border border-red-300 rounded-xl focus:ring-red-500 focus:border-red-500">
            </div>

            <!-- ææ¡ˆãƒœã‚¿ãƒ³ -->
            <button id="generate-button"
                    class="w-full bg-pink-600 text-white font-semibold py-3 rounded-xl hover:bg-pink-700 transition duration-150 shadow-lg flex items-center justify-center disabled:opacity-50"
                    onclick="generateMenu()">
                <!-- ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã€Œä»Šæ—¥ã®çŒ®ç«‹ã‚’ãŠé¡˜ã„ï¼ã€ã«å¤‰æ›´ -->
                <span id="button-text">ä»Šæ—¥ã®çŒ®ç«‹ã‚’ãŠé¡˜ã„ï¼</span>
                <div id="loading-spinner" class="loading-spinner w-5 h-5 border-4 rounded-full ml-2 hidden"></div>
            </button>

            <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="error-message" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden"></div>
        </div>

        <!-- çŒ®ç«‹çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="results-area" class="space-y-6">
            <!-- AIç”ŸæˆçµæœãŒã“ã“ã«å‹•çš„ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
        </div>

        <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ (æ±ç”¨ã‚¢ãƒ©ãƒ¼ãƒˆ) -->
        <div id="message-box" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-lg shadow-2xl w-80">
                <p id="message-text" class="text-gray-700 mb-4 text-center"></p>
                <button onclick="closeMessageBox()" class="w-full bg-pink-600 text-white py-2 rounded-lg hover:bg-pink-700 transition duration-150">OK</button>
            </div>
        </div>

        <!-- è©³ç´°ãƒ¬ã‚·ãƒ”ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="recipe-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden p-4">
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl w-full max-w-xl modal-content">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h3 class="text-2xl font-bold text-gray-800" id="modal-dish-name"></h3>
                    <button onclick="closeRecipeModal()" class="text-gray-500 hover:text-gray-700 text-2xl font-light">
                        &times;
                    </button>
                </div>
                
                <!-- è©³ç´°ãƒ¬ã‚·ãƒ”ã®ãƒ­ãƒ¼ãƒ‰ä¸­/è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div id="modal-loading-spinner" class="text-center py-8 hidden">
                    <div class="loading-spinner w-8 h-8 border-4 mx-auto rounded-full mb-2"></div>
                    <p class="text-pink-600 font-medium">è©³ç´°ãƒ¬ã‚·ãƒ”ã‚’ç”Ÿæˆä¸­...</p>
                </div>

                <div id="modal-content-area">
                    <!-- è©³ç´°ãƒ¬ã‚·ãƒ”ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
                </div>

            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦ingredientsã¨modeã‚’ä¿æŒ
        let currentIngredients = '';
        let currentMode = 'normal';

        document.addEventListener('DOMContentLoaded', () => {
            const modeSelector = document.getElementById('mode-selector');
            const modeButtons = modeSelector.querySelectorAll('.mode-button');
            const currentModeInput = document.getElementById('current-mode');
            const allergyInputGroup = document.getElementById('allergy-input-group');
            
            // ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®åˆ‡ã‚Šæ›¿ãˆãƒ­ã‚¸ãƒƒã‚¯
            modeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    modeButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    const mode = button.getAttribute('data-mode');
                    currentModeInput.value = mode;
                    currentMode = mode; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚‚æ›´æ–°

                    // ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼å…¥åŠ›ã®è¡¨ç¤º/éè¡¨ç¤º
                    if (mode === 'allergy') {
                        allergyInputGroup.classList.remove('hidden');
                    } else {
                        allergyInputGroup.classList.add('hidden');
                        document.getElementById('allergens').value = ''; // ã‚¢ãƒ¬ãƒ«ã‚²ãƒ³å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
                    }
                });
            });
        });

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹åˆ¶å¾¡ (æ±ç”¨ã‚¢ãƒ©ãƒ¼ãƒˆ)
        function showMessageBox(message) {
            document.getElementById('message-text').textContent = message;
            document.getElementById('message-box').classList.remove('hidden');
        }

        function closeMessageBox() {
            document.getElementById('message-box').classList.add('hidden');
        }
        
        // è©³ç´°ãƒ¬ã‚·ãƒ”ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
        function openRecipeModal() {
            document.getElementById('recipe-modal').classList.remove('hidden');
        }

        function closeRecipeModal() {
            document.getElementById('recipe-modal').classList.add('hidden');
            document.getElementById('modal-content-area').innerHTML = ''; // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¯ãƒªã‚¢
        }

        /**
         * çŒ®ç«‹ç”Ÿæˆã®ãƒ¡ã‚¤ãƒ³å‡¦ç†
         */
        async function generateMenu() {
            const ingredients = document.getElementById('ingredients').value.trim();
            const mode = document.getElementById('current-mode').value;
            const allergens = document.getElementById('allergens').value.trim();
            const errorMessageDiv = document.getElementById('error-message');
            const generateButton = document.getElementById('generate-button');
            const buttonText = document.getElementById('button-text');
            const spinner = document.getElementById('loading-spinner');
            const resultsArea = document.getElementById('results-area');

            errorMessageDiv.classList.add('hidden');
            
            if (!ingredients) {
                showMessageBox("ä½¿ã„ãŸã„é£ŸæãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                return;
            }

            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’æ›´æ–°
            currentIngredients = ingredients;
            currentMode = mode;

            // UIã‚’ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«
            generateButton.disabled = true;
            buttonText.textContent = 'AIãŒçŒ®ç«‹ã‚’è€ƒæ¡ˆä¸­...';
            spinner.classList.remove('hidden');
            resultsArea.innerHTML = ''; // çµæœã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢

            try {
                // Vercelã®ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹é–¢æ•°ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ ingredients, mode, allergens }),
                });

                if (!response.ok) {
                    const errorJson = await response.json();
                    let message = errorJson.message || `çŒ®ç«‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status}`;
                    throw new Error(message);
                }

                const data = await response.json();
                // çŒ®ç«‹ãƒ‡ãƒ¼ã‚¿ã¨ã€å…¥åŠ›ã•ã‚ŒãŸingredients, modeã‚’æ¸¡ã™
                renderResults(data.menuData, ingredients, mode);

            } catch (error) {
                console.error("Fetch Error:", error);
                errorMessageDiv.textContent = `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`;
                errorMessageDiv.classList.remove('hidden');
            } finally {
                // UIã‚’é€šå¸¸çŠ¶æ…‹ã«æˆ»ã™
                generateButton.disabled = false;
                // ä¿®æ­£å¾Œã®ãƒ†ã‚­ã‚¹ãƒˆã«æˆ»ã™
                buttonText.textContent = 'ä»Šæ—¥ã®çŒ®ç«‹ã‚’ãŠé¡˜ã„ï¼';
                spinner.classList.add('hidden');
            }
        }

        /**
         * çŒ®ç«‹çµæœã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ (è©³ç´°ãƒœã‚¿ãƒ³ä»˜ã)
         * @param {Array<Object>} menuData - AIã‹ã‚‰è¿”ã•ã‚ŒãŸçŒ®ç«‹ãƒ‡ãƒ¼ã‚¿
         */
        function renderResults(menuData) {
            const resultsArea = document.getElementById('results-area');
            resultsArea.innerHTML = ''; // çµæœã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢

            // çŒ®ç«‹ãƒ¬ãƒ™ãƒ«ã®è¡¨ç¤ºé †ã‚’å®šç¾©
            const order = {
                'ç©¶æ¥µã®ã‚ºãƒœãƒ©é£¯ (5åˆ†ä»¥å†…)': 1, 
                'æ‰‹è»½ãƒ»æ™‚çŸ­çŒ®ç«‹': 2,
                'ã¡ã‚‡ã£ã¨ã²ã¨æ‰‹é–“çŒ®ç«‹': 3
            };

            // å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å®šç¾©ã—ãŸé †åºã§ã‚½ãƒ¼ãƒˆ
            const sortedData = menuData.sort((a, b) => {
                return order[a.level] - order[b.level];
            });

            sortedData.forEach(menu => {
                let cardClass = '';
                let levelName = menu.level;
                let levelIcon = '';
                let levelColor = '';

                // ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦ãƒ‡ã‚¶ã‚¤ãƒ³ã¨åç§°ã‚’æ±ºå®š
                if (levelName === 'ç©¶æ¥µã®ã‚ºãƒœãƒ©é£¯ (5åˆ†ä»¥å†…)') {
                    cardClass = 'bg-yellow-50 border-yellow-300';
                    levelIcon = 'ğŸ˜´'; // ã‚ºãƒœãƒ©
                    levelColor = 'bg-yellow-500';
                } else if (levelName === 'æ‰‹è»½ãƒ»æ™‚çŸ­çŒ®ç«‹') { // ä¿®æ­£
                    cardClass = 'bg-green-50 border-green-300';
                    levelIcon = 'â±ï¸'; // æ™‚çŸ­
                    levelColor = 'bg-green-500';
                } else if (levelName === 'ã¡ã‚‡ã£ã¨ã²ã¨æ‰‹é–“çŒ®ç«‹çŒ®ç«‹') {
                    cardClass = 'bg-pink-50 border-pink-300';
                    levelIcon = 'ğŸ‘‘'; // ã²ã¨æ‰‹é–“
                    levelColor = 'bg-pink-500';
                } else {
                    cardClass = 'bg-gray-50 border-gray-300';
                    levelIcon = 'ğŸ³';
                    levelColor = 'bg-gray-500';
                }

                const cardHtml = `
                    <div class="card ${cardClass} border-2 p-6 rounded-2xl transition duration-300 hover:shadow-xl">
                        <h3 class="text-xl md:text-2xl font-bold text-gray-800 mb-2 flex items-center">
                            <span class="p-1 rounded-full text-white ${levelColor} mr-3">
                                ${levelIcon}
                            </span>
                            ${levelName}
                        </h3>
                        
                        <h4 class="text-lg font-semibold text-gray-700 mb-2">${menu.dishName}</h4>
                        <p class="text-gray-600 mb-4">${menu.description}</p>
                        
                        <div class="p-4 bg-white rounded-xl border border-dashed border-pink-200 mb-4">
                            <h5 class="text-md font-bold text-gray-700 mb-2 flex items-center text-pink-600">
                                <span class="mr-2">ğŸ’¡</span>èª¿ç†ã®ãƒã‚¤ãƒ³ãƒˆ
                            </h5>
                            <div class="text-sm text-gray-600 recipe-summary-content">
                                ${formatSummary(menu.recipeSummary)}
                            </div>
                        </div>
                    </div>
                `;
                resultsArea.insertAdjacentHTML('beforeend', cardHtml);
            });
        }

        /**
         * è©³ç´°ãƒ¬ã‚·ãƒ”ã‚’ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹é–¢æ•°ã‹ã‚‰å–å¾—ã—ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã«è¡¨ç¤ºã™ã‚‹
         * @param {string} dishName - è©³ç´°ã‚’å–å¾—ã—ãŸã„çŒ®ç«‹å
         */
        async function fetchDetailRecipe(dishName) {
            const modalName = document.getElementById('modal-dish-name');
            const modalContent = document.getElementById('modal-content-area');
            const modalSpinner = document.getElementById('modal-loading-spinner');
            const errorMessageDiv = document.getElementById('error-message');

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã€çŒ®ç«‹åã‚’è¨­å®š
            modalName.textContent = dishName;
            modalContent.innerHTML = '';
            openRecipeModal();
            
            // UIã‚’ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«
            modalSpinner.classList.remove('hidden');
            errorMessageDiv.classList.add('hidden');
            
            try {
                // æ–°ã—ãä½œæˆã—ãŸã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹é–¢æ•° /api/detail ã‚’å‘¼ã³å‡ºã™
                // ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹é–¢æ•°ãŒãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼ã‚’è§£æ¶ˆã™ã‚‹ãŸã‚ã€api/detail.js ã‚’ä½œæˆã—ã¾ã™
                const response = await fetch('/api/detail', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        dishName: dishName,
                        ingredients: currentIngredients, // æœ€åˆã®å…¥åŠ›é£Ÿæã‚’æ¸¡ã™
                        mode: currentMode // é¸æŠä¸­ã®ãƒ¢ãƒ¼ãƒ‰ã‚’æ¸¡ã™
                    }),
                });

                if (!response.ok) {
                    // JSONã‚¨ãƒ©ãƒ¼ã§ã¯ãªãã€ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ­£ã—ãå‡¦ç†ã™ã‚‹
                    let errorText;
                    try {
                        // å¿œç­”ãŒJSONå½¢å¼ã§ã‚ã‚Œã°è§£æ
                        const errorJson = await response.json();
                        errorText = errorJson.message || `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status}`;
                    } catch {
                        // å¿œç­”ãŒJSONå½¢å¼ã§ãªã‘ã‚Œã°ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦å–å¾—
                        errorText = await response.text();
                    }
                    throw new Error(errorText);
                }

                const data = await response.json();
                renderDetailRecipe(data.detailRecipe);

            } catch (error) {
                console.error("Detail Recipe Fetch Error:", error);
                closeRecipeModal();
                showMessageBox(`è©³ç´°ãƒ¬ã‚·ãƒ”ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
            } finally {
                // UIã‚’é€šå¸¸çŠ¶æ…‹ã«æˆ»ã™
                modalSpinner.classList.add('hidden');
            }
        }
        
        /**
         * æ „é¤Šåˆ†æã®ãƒ€ãƒŸãƒ¼å‡¦ç†ï¼ˆæœªå®Ÿè£…ï¼‰
         */
        function fetchNutritionAnalysis(dishName) {
            showMessageBox(`ã€Œ${dishName}ã€ã®æ „é¤Šåˆ†ææ©Ÿèƒ½ã‚’å®Ÿè¡Œã—ã‚ˆã†ã¨ã—ã¾ã—ãŸãŒã€ç¾åœ¨ã“ã®æ©Ÿèƒ½ã¯ã¾ã é–‹ç™ºä¸­ã§ã™ï¼ğŸ˜‹`);
        }

        /**
         * è©³ç´°ãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹
         * @param {Object} recipeData - è©³ç´°ãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿
         */
        function renderDetailRecipe(recipeData) {
            const modalContent = document.getElementById('modal-content-area');
            
            const ingredientsHtml = `
                <div class="mb-6">
                    <h4 class="text-xl font-bold text-pink-600 mb-3 border-b-2 border-pink-200 pb-1">ææ–™ (${recipeData.yield})</h4>
                    <p class="text-sm text-gray-500 mb-2">èª¿ç†æ™‚é–“: ${recipeData.totalTime}</p>
                    <ul class="list-disc pl-5 space-y-2 text-gray-700">
                        ${recipeData.ingredientsList.map(item => `<li>${item}</li>`).join('')}
                    </ul>
                </div>
            `;

            const instructionsHtml = `
                <div class="mb-4">
                    <h4 class="text-xl font-bold text-pink-600 mb-3 border-b-2 border-pink-200 pb-1">ä½œã‚Šæ–¹</h4>
                    <ol class="list-decimal pl-5 space-y-3 text-gray-700">
                        ${recipeData.instructions.map(item => `<li>${item}</li>`).join('')}
                    </ol>
                </div>
            `;

            modalContent.innerHTML = ingredientsHtml + instructionsHtml;
        }


        /**
         * AIãŒè¿”ã—ãŸç®‡æ¡æ›¸ãã‚’ç•ªå·ä»˜ããƒªã‚¹ãƒˆã«å¤‰æ›ã™ã‚‹
         */
        function formatSummary(summaryHtml) {
            // AIãŒ <ul><li>ã‚¿ã‚°ã‚’ä½¿ç”¨ã™ã‚‹å‰æã§ã€ãã‚Œã‚’ <ol><li>ã«å¤‰æ›
            if (summaryHtml.includes('<ul>')) {
                // <ul> ã‚’ <ul class="list-none space-y-2"> ã«ç½®æ›
                summaryHtml = summaryHtml.replace(/<ul\s*[^>]*>/gi, '<ul class="list-none space-y-2">');
                // </ul> ã‚’ </ul> ã«ç½®æ›ï¼ˆç•ªå·ã¯AIå´ã§ä»˜ä¸ã•ã‚Œã‚‹å‰æï¼‰
                summaryHtml = summaryHtml.replace(/<\/ul\s*[^>]*>/gi, '</ul>');
            }
            return summaryHtml;
        }

    </script>
</body>
</html>
